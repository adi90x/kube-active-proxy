#
# This is the template use to grab host to setup with Let's Encrypt SSL
# Environment Variable can set DEFAULT_EMAIL and KAP_LE_TEST
# KAP_LE_TEST override is currently set to : {{ env "KAP_LE_TEST" }}
# DEFAULT_EMAIL override is currently set to : {{ env "DEFAULT_EMAIL" }}


{{ $default_email := or (env "DEFAULT_EMAIL") "foo@bar.com" -}}

{{- $hosts_services := services "" "" | getAllLabelValue "*" "kap/le_host" "," -}}
{{- $hosts_stand := pods "" "" | getAllLabelValue "*" "kap/le_host" "," -}}
{{- $hosts := concatenateUnique $hosts_services $hosts_stand -}}

LETSENCRYPT_CONTAINERS=(
{{- range $hosts }}'{{ formatClean . }}' {{ end -}}
)


{{- $services := services "" "" | groupByMulti "kap/le_host" "," -}}
{{- $pods := pods "" "" | groupByMulti "kap/le_host" "," -}}
{{- $aggregated := uniqueMap $pods $services -}}
{{- range $host, $agg := $aggregated -}}
{{- $first := first $agg -}}
{{- $cid := formatClean $host -}}
{{- $default_secret_name := print "kap-" $host }}


LETSENCRYPT_{{$cid}}_HOST=( '{{$host}}' )
LETSENCRYPT_{{$cid}}_EMAIL="{{GetValue $first.Annotations "kap/le_email" $default_email}}"
LETSENCRYPT_{{$cid}}_TEST="{{GetValue $first.Annotations "kap/le_test" "false"}}"
LETSENCRYPT_{{$cid}}_K8S_SECRET_NS="{{GetValue $first.Annotations "kap/k8s_secret_ns" "false"}}"
LETSENCRYPT_{{$cid}}_K8S_SECRET_NAME="{{GetValue $first.Annotations "kap/k8s_secret_name" $default_secret_name}}"


{{- end }}

